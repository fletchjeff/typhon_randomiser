<!DOCTYPE html>

<html lang="en">

  <head>
    <meta charset="UTF-8">
    <title>WebMidi.js Quick Start</title>
    <script src="https://cdn.jsdelivr.net/npm/webmidi@latest/dist/iife/webmidi.iife.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="input-knobs.js"></script>
    <script type="module">

        // Enable WEBMIDI.js and trigger the onEnabled() function when ready
        WebMidi
          .enable()
          .then(onEnabled)
          .catch(err => alert(err));
      
        // Function triggered when WEBMIDI.js is ready
        function onEnabled() {
            console.log(WebMidi.outputs);
        //     document.body.innerHTML+= "No device detected.";
        //   } else {
        //     WebMidi.outputs)
          // Display available MIDI input devices
        //   if (WebMidi.outputs.length < 1) {
        //     document.body.innerHTML+= "No device detected.";
        //   } else {
        //     WebMidi.outputs.forEach((device, index) => {
        //       document.body.innerHTML+= `${index}: ${device.name} <br>`;
        //     });
        //   }
      
        }

      </script>  
</head>
  
  <body>
    <h1>WebMidi.js Quick Start</h1>
    <!-- <input type="range" class="input-slider" data-width = "15" data-height = "120" min="0" max="127" step="1" data-bgcolor="#111" data-fgcolor="#029b33" oninput="send_midi_cc(this.value)"/> -->
    <input type="range" class="input-knob" data-bgcolor="#111" data-fgcolor="#029b33" min="0" max="127" step="1" data-diameter="100" oninput="send_midi_cc(parseInt(d3.select('#cc_val').node().value),this.value)"/>
    <div id="current_val"></div>
    <div class="cc_dropdown">
        <select name="cc_val" id="cc_val">
        </select>          
    </div>   
  
    <div id="main_div">
        Main Div
    </div>
    <script>
    let cc_range = d3.range(1,100,1)

    d3.select("#cc_val")
        .selectAll("option")
        .data(cc_range)
        .join("option") // the join method
            .attr("value",(d) => d)
            .text((d) => d)
    

    function create_cc_divs(all_cc_names) {
        d3.select("#main_div")
            .selectAll("div")
            .data(all_cc_names)
            .join("div")
            .attr("id",(d) => {
                return "section_" + d[0]
            })
            .text((d) => {
                console.log(d)
                return d[0]
            })
            .append("input")
            .attr("type","range")
            .attr("class","input-slider")
              // d.keys()
            
    }

    let data;
    d3.dsv(",", "typhon_cc_data.csv")
        .then(function(d) {
        console.log(d);
        data = d;
        create_cc_divs(d3.group(data,d => d.CC_NAME))
        })
        .catch(error => {
        console.error(error);
        })

    

    function send_midi_cc(cc_num,cc_val) {
        console.log(cc_val);
        d3.select("#current_val").text(cc_val)
        WebMidi.getOutputByName('Typhon').channels[9].sendControlChange(cc_num, cc_val);
    }
    </script>
</body>


</html>